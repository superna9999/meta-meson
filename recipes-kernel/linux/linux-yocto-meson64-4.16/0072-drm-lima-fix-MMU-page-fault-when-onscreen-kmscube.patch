From ce67bbf720bb3d7b1fbc9540ec3fe9c2af90d909 Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Sat, 25 Nov 2017 14:54:41 +0800
Subject: [PATCH] drm/lima: fix MMU page fault when onscreen kmscube

Signed-off-by: Qiang Yu <yuq825@gmail.com>
---
 drivers/gpu/drm/lima/lima_mmu.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/lima/lima_mmu.c b/drivers/gpu/drm/lima/lima_mmu.c
index 0aba9be..56dc71a 100644
--- a/drivers/gpu/drm/lima/lima_mmu.c
+++ b/drivers/gpu/drm/lima/lima_mmu.c
@@ -126,8 +126,15 @@ void lima_mmu_switch_vm(struct lima_mmu *mmu, struct lima_vm *vm, bool reset)
 	if (mmu->vm == vm) {
 		if (reset)
 			vm = dev->empty_vm;
-		else if (!mmu->zap_all)
+		else {
+			/* TODO: mmu->zap_all was designed here when active VM is
+			 * updated, zap the MMU TLB. But seems we need always do zap
+			 * (without stall) before start task with the same VM. So
+			 * the MMU TLB can't keep across tasks with the same VM?
+			 */
+			mmu_write(COMMAND, LIMA_MMU_COMMAND_ZAP_CACHE);
 			goto out;
+		}
 	}
 
 	lima_mmu_send_command(LIMA_MMU_COMMAND_ENABLE_STALL,
