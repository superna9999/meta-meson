From a369fb82ed8ced4f5a6a1f32d5640d4b8a864b90 Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Sat, 12 May 2018 12:25:15 +0800
Subject: [PATCH 98/98] drm/lima: add lima_gem_get_sync_fd

Signed-off-by: Qiang Yu <yuq825@gmail.com>
---
 drivers/gpu/drm/lima/lima_gem.c | 34 +++++++++++++++++++++-------------
 1 file changed, 21 insertions(+), 13 deletions(-)

diff --git a/drivers/gpu/drm/lima/lima_gem.c b/drivers/gpu/drm/lima/lima_gem.c
index 9eee0d7..e8a3815 100644
--- a/drivers/gpu/drm/lima/lima_gem.c
+++ b/drivers/gpu/drm/lima/lima_gem.c
@@ -318,6 +318,25 @@ static int lima_gem_add_deps(struct lima_ctx_mgr *mgr, struct lima_submit *submi
 	return err;
 }
 
+static int lima_gem_get_sync_fd(struct dma_fence *fence)
+{
+	struct sync_file *sync_file;
+	int fd;
+
+	fd = get_unused_fd_flags(O_CLOEXEC);
+	if (fd < 0)
+		return fd;
+
+	sync_file = sync_file_create(fence);
+	if (!sync_file) {
+		put_unused_fd(fd);
+		return -ENOMEM;
+	}
+
+	fd_install(fd, sync_file->file);
+	return fd;
+}
+
 int lima_gem_submit(struct drm_file *file, struct lima_submit *submit)
 {
 	int i, err = 0;
@@ -372,23 +391,12 @@ int lima_gem_submit(struct drm_file *file, struct lima_submit *submit)
 	}
 
 	if (submit->flags & LIMA_SUBMIT_FLAG_SYNC_FD_OUT) {
-		struct sync_file *sync_file;
-		int fd;
-
-		fd = get_unused_fd_flags(O_CLOEXEC);
+		int fd = lima_gem_get_sync_fd(
+			&submit->task->base.s_fence->finished);
 		if (fd < 0) {
 			err = fd;
 			goto out2;
 		}
-
-		sync_file = sync_file_create(
-			&submit->task->base.s_fence->finished);
-		if (!sync_file) {
-			put_unused_fd(fd);
-			err = -ENOMEM;
-			goto out2;
-		}
-		fd_install(fd, sync_file->file);
 		submit->sync_fd = fd;
 	}
 
-- 
2.0.1

